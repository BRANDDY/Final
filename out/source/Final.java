/* autogenerated by Processing revision 1276 on 2021-12-12 */
import processing.core.*;
import processing.data.*;
import processing.event.*;
import processing.opengl.*;

import processing.sound.*;

import java.util.HashMap;
import java.util.ArrayList;
import java.io.File;
import java.io.BufferedReader;
import java.io.PrintWriter;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.IOException;

public class Final extends PApplet {



TriOsc triOsc;

int red, green, blue;


 public void setup() {
    triOsc = new TriOsc(this);
    triOsc.play(60, 0.8f);
    /* size commented out by preprocessor */;
    setButton();
    noteList = new Buttons[100];
}


 public void draw() {
    background(red, green, blue);
    startUi(); 
}
/*void keyPressed() {
red = int(random(255));
green = int(random(255));
blue = int(random(255));
//为键盘上的每个数字分配声音。1 5 玩
//文件原始音高以下的八度，6-0 播放
//以上八度音阶。
switch(key) {
case'1':

triOsc.play(midiToFreq(60), 0.8);
break;
case'2':
triOsc.play(midiToFreq(61), 0.8);1
break;
case'3':
triOsc.play(midiToFreq(62), 0.8);
break;
case'4':
triOsc.play(midiToFreq(63), 0.8);2
break;
case'5':
triOsc.play(midiToFreq(64), 0.8);
break;
case'6':
triOsc.play(midiToFreq(65), 0.8);3
break;
case'7':
triOsc.play(midiToFreq(66), 0.8);4
break;
case'8':
triOsc.play(midiToFreq(67), 0.8);
break;
case'9':
triOsc.play(midiToFreq(68), 0.8);
break;
case'0' : 
triOsc.play(midiToFreq(69), 0.8);
break;
    }
}*/


Buttons[] buttonList;
PVector buttonSize = new PVector(50,60);
int colour = 255;
Buttons note;
Buttons[] noteList; 
int noteSize = 100;
int noteOrder = 0;
boolean play = false;
boolean move = false;
boolean addNote = true;


 public void setButton() {
    PVector loc = new PVector(510,30);
    buttonList = new Buttons[8];
    for (int i = 0;i < 2;i++) {
        for (int t = 0;t < 4;t++) {
            int scale = 60 + 2 * (t + i * 4) - 1;
            if ((t + i * 4)>= 4) {
                scale = scale - 1;
            }
            buttonList[t + i * 4] = new Buttons(scale,1,loc);
            loc.y = loc.y + 60 + 20;
        }
        loc.x += 70;     
        loc.y = 30;   
    } 
}

 public void startUi() {
    fill(255);
    rect(20, 20, 475, 320, 28);
    for (int i = 0;i < 8;i++) {
        buttonList[i].update();
    }
    for (int i = 0;i < noteOrder;i++) {
        noteList[i].update();
    }
}


class Buttons{
    PVector bLoc = new PVector();
    int scale, pitch;
    
    Buttons(int s, int p,PVector l) {
        bLoc = new PVector();
        bLoc.x = l.x;
        bLoc.y = l.y;
        scale = s;
        pitch = p;
    }
    Buttons() {
        bLoc = new PVector();
    }
    
     public void update() {
        fill(colour);
        rect(bLoc.x, bLoc.y, buttonSize.x, buttonSize.y, 28);
    }
    
}
 public float midiToFreq(int n, int p) {
    return(pow(2,((n - 69) / 12.0f))) * 440  * p;
}



 public void mousePressed() {       
    if (mouseX > 510) { 
        addNote = true;
        for (int i = 0;i < 8;i++) { 
            if (mouseX > buttonList[i].bLoc.x && mouseX < buttonList[i].bLoc.x + buttonSize.x 
                && mouseY > buttonList[i].bLoc.y && mouseY < buttonList[i].bLoc.y + buttonSize.y) {
                if (i!= 0) {
                    note = new Buttons();
                    cloneMember(note, buttonList[i]);
                    play = true;
                } else{
                    play = false;
                }
            }            
        } 
    } else if(noteOrder>0){
        addNote = false;
        for (int i = 0;i < noteOrder;i++) {
            if (mouseX > noteList[i].bLoc.x && mouseX < noteList[i].bLoc.x + 50 
                && mouseY > noteList[i].bLoc.y && mouseY < noteList[i].bLoc.y + 60) {
                note = new Buttons();
                note = noteList[i];
                play = true;
            }  
        }
    }   
}

 public void cloneMember(Buttons a, Buttons b) {
    a.bLoc.x = b.bLoc.x;
    a.bLoc.y = b.bLoc.y;
    a.scale = b.scale;
    a.pitch = b.pitch;
    //a.colour = b.colour;
}

 public void mouseReleased() {
    if (!play) {
        triOsc.stop();
    } else{
        triOsc.play(midiToFreq(note.scale,note.pitch), 0.8f);
    }
    if (move&addNote) {
        noteList[noteOrder]=new Buttons();
        cloneMember(noteList[noteOrder],note);
        move = false;
        noteOrder +=1;
    }
}

 public void mouseDragged() {
    drag();
    move = true;
}

 public void drag() {
    if (play) {
        note.bLoc.x = mouseX;
        note.bLoc.y = mouseY;
        note.update();
    }
}


  public void settings() { size(640, 360); }

  static public void main(String[] passedArgs) {
    String[] appletArgs = new String[] { "Final" };
    if (passedArgs != null) {
      PApplet.main(concat(appletArgs, passedArgs));
    } else {
      PApplet.main(appletArgs);
    }
  }
}
