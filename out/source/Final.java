/* autogenerated by Processing revision 1276 on 2021-12-11 */
import processing.core.*;
import processing.data.*;
import processing.event.*;
import processing.opengl.*;

import processing.sound.*;

import java.util.HashMap;
import java.util.ArrayList;
import java.io.File;
import java.io.BufferedReader;
import java.io.PrintWriter;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.IOException;

public class Final extends PApplet {


TriOsc triOsc;
Buttons[] buttonList;
Buttons note;
ArrayList<Buttons> noteList;
PVector buttonSize = new PVector(50,60);


 public void setup() {
    triOsc = new TriOsc(this);
    buttonList = new Buttons[8];
    triOsc.play(60, 0.8f);
    /* size commented out by preprocessor */;
    setButton();
    noteList = new ArrayList<Buttons>();
}

 public void draw() {
    background(0);
    startUi(); 
}
PVector colours;
int red, green,blue;

 public void startUi() {
    fill(255);
    rect(20, 20, 475, 320, 28);
    int y1 = 20;
    for (int i = 0;i < 5;i++) {
        y1 += 53;
        line(20,y1,490,y1);
    }    
    for (int i = 0;i < 8;i++) {
        buttonList[i].update();
    }
    for (int i = 0;i < noteList.size();i++) {
        noteList.get(i).update();
    }
}

 public void setButton() {
    PVector loc = new PVector(510,30);
    for (int i = 0;i < 2;i++) {
        for (int t = 0;t < 4;t++) {
            int scale = 60 + 2 * (t + i * 4) - 1;
            if ((t + i * 4)>= 4) {
                scale = scale - 1;
            }
            setColour(t + i * 4);
            buttonList[t + i * 4] = new Buttons(scale,1,loc,colours);
            loc.y = loc.y + 60 + 20;
        }
        loc.x += 70;     
        loc.y = 30;   
    } 
}

 public void setColour(int i) {
    switch(i) {
        case 0 : red = 255;green = 255;blue = 255; break;
        case 1 : red = 255;green = 50;blue = 50; break;
        case 2 : red = 255;green = 100;blue = 50; break;
        case 3 : red = 255;green = 255;blue = 50; break;
        case 4 : red = 50;green = 255;blue = 50; break;
        case 5 : red = 0;green = 255;blue = 200; break;
        case 6 : red = 50;green = 150;blue = 255; break;
        case 7 : red = 150;green = 50;blue = 255; break;
    }
    colours = new PVector(red,green,blue);
}


class Buttons{
    PVector bLoc;
    int scale, pitch;
    PVector colour;
    
    Buttons(int s, int p,PVector l,PVector c) {
        bLoc = new PVector(l.x,l.y);
        scale = s;
        pitch = p;
        colour = new PVector(c.x,c.y,c.z);
        
    }
    Buttons() {
        bLoc = new PVector();
    }
    
     public void update() {
        fill(colour.x,colour.y,colour.z);
        rect(bLoc.x, bLoc.y, buttonSize.x, buttonSize.y, 28);
    }
}

 public float midiToFreq(int n, int p) {
    return(pow(2,((n - 69) / 12.0f))) * 440  * p;
}
boolean play = false;
boolean move = false;
boolean addNote = true;
boolean dontRemove = false;

 public void mousePressed() {       
    if (mouseX > 460) { 
        for (int i = 0;i < 8;i++) { 
            if (mouseX > buttonList[i].bLoc.x && mouseX < buttonList[i].bLoc.x + buttonSize.x 
                && mouseY > buttonList[i].bLoc.y && mouseY < buttonList[i].bLoc.y + buttonSize.y) {
                if (i!= 0) {
                    addNote = true;
                    note = new Buttons();
                    cloneMember(note, buttonList[i]);
                    play = true;
                    dontRemove=false;
                } else{
                    addNote = false;
                    play = false;
                    dontRemove=true;
                    playMusic();
                }
            }            
        } 
    } else{
        addNote = false;
        for (int i = 0;i < noteList.size();i++) {
            if (mouseX > noteList.get(i).bLoc.x && mouseX < noteList.get(i).bLoc.x + buttonSize.x 
                && mouseY > noteList.get(i).bLoc.y && mouseY < noteList.get(i).bLoc.y + buttonSize.y) {
                note = noteList.get(i);
                play = true;
            }  
        }
    }   
}

 public void cloneMember(Buttons a, Buttons b) {
    a.bLoc.x = b.bLoc.x;
    a.bLoc.y = b.bLoc.y;
    a.scale = b.scale;
    a.pitch = b.pitch;
    a.colour = b.colour;
}

 public void mouseReleased() {
    if (!play) {
        triOsc.stop();
    } else{
        triOsc.play(midiToFreq(note.scale,note.pitch), 0.8f);
    }
    if (move) {
        if (mouseX > 460&&!dontRemove) {
            noteList.remove(note);
            play = false;
        } else if (addNote) {
            noteList.add(note);
        }
        move = false;
    }
}

 public void mouseDragged() {
    if (play) {
        note.bLoc.x = mouseX;
        note.bLoc.y = mouseY;
        note.update();
    }
    move = true;
}
ArrayList<ArrayList<Buttons>> rowList = new ArrayList<ArrayList<Buttons>>();
ArrayList<Buttons> music = new ArrayList<Buttons>();
int trigger = 0;

 public void playMusic() {
    organize();
    if (music.size()>0) {
        for (int i = 0;i < music.size() + 1;i++) {
            trigger = millis() + 300;
            while(millis() < trigger) {
                if (keyCode ==  UP) {
                    break;
                }
            }
            if (i!= (music.size())) {
                triOsc.play(midiToFreq(music.get(i).scale,music.get(i).pitch), 0.8f);
            }   
        }
    } else{
        println("NullMusic");
    }
    music.clear();
    rowList.clear();
}

 public void organize() {
    orgRow(); 
    for (int n = 0;n < 6;n++) {
        while(rowList.get(n).size()> 0) {
            for (int i = 0;i < rowList.get(n).size();i++) {
                boolean small = true;
                for (int t = 0;t < rowList.get(n).size();t++) {
                    if (i!= t &&  rowList.get(n).get(i).bLoc.x>rowList.get(n).get(t).bLoc.x) {
                        small = false;
                    }
                }
                if (small) {
                    music.add(rowList.get(n).get(i));
                    rowList.get(n).remove(i);
                }
            }
        }
    }
}

 public void orgRow() {
    int row;
    ArrayList<Buttons> row0 = new ArrayList<Buttons>();
    ArrayList<Buttons> row1 = new ArrayList<Buttons>();
    ArrayList<Buttons> row2 = new ArrayList<Buttons>();
    ArrayList<Buttons> row3 = new ArrayList<Buttons>();
    ArrayList<Buttons> row4 = new ArrayList<Buttons>();
    ArrayList<Buttons> row5 = new ArrayList<Buttons>();
    for (int i = 0;i < noteList.size();i++) {
        float y = noteList.get(i).bLoc.y;
        if (y > 10 &&  y < 60) {
            row0.add(noteList.get(i));
        } 
        else if (y >= 60 &&  y < 110) {
            row1.add(noteList.get(i));
        }
        else if (y >= 110 &&  y < 160) {
            row2.add(noteList.get(i));
        }
        else if (y >= 160 &&  y < 210) {
            row3.add(noteList.get(i));
        }
        else if (y >= 210 &&  y < 260) {
            row4.add(noteList.get(i));
        }
        else if (y >= 260 &&  y < 300) {
            row5.add(noteList.get(i));
        } else{
            println(i + "wrong row" + y);
            break;
        }    
    } 
    rowList.add(row0);  
    rowList.add(row1);  
    rowList.add(row2);  
    rowList.add(row3);  
    rowList.add(row4);  
    rowList.add(row5);  
}


  public void settings() { size(640, 360); }

  static public void main(String[] passedArgs) {
    String[] appletArgs = new String[] { "Final" };
    if (passedArgs != null) {
      PApplet.main(concat(appletArgs, passedArgs));
    } else {
      PApplet.main(appletArgs);
    }
  }
}
